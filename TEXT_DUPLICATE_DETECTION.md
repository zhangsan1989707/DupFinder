# 文本查重功能使用说明

## 功能概述

本项目已成功添加了文本查重功能，现在支持两种模式：
- **视频查重模式**：原有的视频文件重复检测功能
- **文本查重模式**：新增的文本文件重复检测功能

## 文本查重特性

### 支持的文件类型
文本查重功能支持以下文件扩展名：
- 文档文件：`.txt`, `.md`, `.rtf`, `.rst`
- 代码文件：`.py`, `.js`, `.java`, `.cpp`, `.c`, `.h`, `.cs`, `.php`, `.rb`, `.go`, `.rs`, `.swift`, `.kt`, `.scala`, `.pl`, `.sh`, `.bat`, `.ps1`
- 配置文件：`.json`, `.xml`, `.yml`, `.yaml`, `.ini`, `.conf`, `.cfg`
- 数据文件：`.csv`, `.log`, `.sql`
- 网页文件：`.html`, `.htm`, `.css`
- 其他：`.tex`, `.wiki`, `.adoc`, `.asciidoc`

### 检测算法

文本查重使用多层检测算法：

1. **精确重复检测**
   - 基于MD5哈希值
   - 检测完全相同的文件（100%相似度）

2. **相似度检测**
   - **序列相似度**：使用difflib计算文本序列相似性
   - **词汇相似度**：基于Jaccard系数计算词汇重叠度
   - **N-gram相似度**：分析文本的2-gram和3-gram特征
   - **结构相似度**：比较句子数量、平均句子长度等结构特征

3. **文本预处理**
   - Unicode标准化
   - 空白字符规范化
   - 大小写统一
   - 编码自动检测（支持UTF-8、GBK、GB2312等）

### 性能优化

- **并行处理**：支持多线程并行计算相似度
- **文件过滤**：自动跳过过大文件（默认50MB限制）
- **智能编码检测**：使用chardet库自动检测文件编码
- **内存优化**：避免同时加载过多文件内容

## 使用方法

### GUI界面使用

1. **启动程序**
   ```bash
   python run.py
   ```

2. **选择模式**
   - 在顶部工具栏选择"文本查重"模式
   - 窗口标题会显示"智能文件查重工具 v1.0 - 文本模式"

3. **添加扫描路径**
   - 点击"添加路径"按钮选择要扫描的目录
   - 可以添加多个目录路径

4. **设置相似度阈值**
   - 使用相似度滑块设置检测阈值（50%-100%）
   - 默认值为80%

5. **开始扫描**
   - 点击"开始扫描"按钮启动检测
   - 程序会显示扫描进度和统计信息

6. **查看结果**
   - 结果以树形结构显示重复文件组
   - 每个文件显示：文件路径、大小、行数、字符数、相似度
   - 支持右键菜单打开文件或文件夹

7. **选择处理策略**
   - 手动选择：手动勾选要保留的文件
   - 保留最大尺寸：保留字符数最多的文件
   - 保留最小大小：保留文件体积最小的文件
   - 保留最新文件：保留修改时间最新的文件
   - 保留最旧文件：保留修改时间最旧的文件

8. **执行处理**
   - 点击"执行处理"将未选中的文件移动到回收站

### 命令行测试

可以使用提供的测试脚本进行功能验证：

```bash
python test_text_detection.py
```

## 技术实现

### 核心模块

1. **文本扫描器** (`src/scanner/text_scanner.py`)
   - 扫描指定目录下的文本文件
   - 自动检测文件编码
   - 提取文件基本信息（大小、行数、字符数等）

2. **文本重复检测器** (`src/detector/text_duplicate_detector.py`)
   - 实现多种相似度算法
   - 支持并行处理
   - 提供详细的相似度分析

3. **GUI界面扩展** (`src/gui/main_window.py`)
   - 添加模式切换功能
   - 适配文本文件显示格式
   - 支持文本特有的选择策略

### 依赖库

新增的文本处理依赖：
- `chardet==5.2.0`：自动检测文件编码

## 测试结果

测试显示文本查重功能正常工作：

```
找到 4 个文本文件:
  - different.txt: 222 字节, 5 行, 132 字符
  - test1.txt: 190 字节, 4 行, 102 字符
  - test2.txt: 190 字节, 4 行, 102 字符
  - test3.txt: 209 字节, 4 行, 109 字符

找到 1 组重复文件:
重复组 1 (2 个文件):
  - test1.txt: 100.0% 相似度 (exact)
  - test2.txt: 100.0% 相似度 (exact)
```

## 配置选项

### 文件大小限制
默认限制单个文件最大50MB，可在`TextScanner`初始化时修改：

```python
scanner = TextScanner(max_file_size=100 * 1024 * 1024)  # 100MB
```

### 相似度阈值
可在GUI界面调整，或在代码中设置：

```python
detector = TextDuplicateDetector(similarity_threshold=85.0)  # 85%
```

### 并发线程数
默认使用4个工作线程，可根据机器性能调整：

```python
detector = TextDuplicateDetector(max_workers=8)
```

## 注意事项

1. **文件编码**：程序会自动检测文件编码，但建议使用UTF-8编码的文本文件以获得最佳效果
2. **文件大小**：超过50MB的文件会被自动跳过，避免内存溢出
3. **相似度计算**：相似度计算是CPU密集型操作，大量文件可能需要较长时间
4. **文件安全**：处理操作会将文件移动到回收站，而不是永久删除

## 扩展建议

1. **支持更多文件格式**：可以扩展支持PDF、Word文档等
2. **语义分析**：集成NLP库进行更深层的语义相似度分析
3. **增量扫描**：支持只扫描修改过的文件
4. **结果导出**：支持将检测结果导出为CSV或JSON格式